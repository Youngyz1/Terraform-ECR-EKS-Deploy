name: Manual Deploy - Terraform ECR to EKS

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select deployment environment"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging

env:
  AWS_REGION: us-east-1

jobs:
  build-and-push:
    name: Build Docker & Push to ECR
    runs-on: ubuntu-latest
    outputs:
      image_uri: ${{ steps.export.outputs.image_uri }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Ensure ECR repository exists
        run: |
          REPO_NAME="uchenewwebsit-repo"
          if ! aws ecr describe-repositories --repository-names $REPO_NAME >/dev/null 2>&1; then
            echo "ðŸ”§ Creating ECR repository: $REPO_NAME"
            aws ecr create-repository --repository-name $REPO_NAME --region $AWS_REGION
          else
            echo "âœ… ECR repository already exists."
          fi

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & Push Docker image
        id: build
        run: |
          IMAGE_TAG=${GITHUB_SHA}
          IMAGE_URI=${{ steps.login-ecr.outputs.registry }}/uchenewwebsit-repo:$IMAGE_TAG
          echo "ðŸ§± Building Docker image: $IMAGE_URI"
          docker build -t $IMAGE_URI .
          docker push $IMAGE_URI
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV
          echo "image_uri=$IMAGE_URI" >> $GITHUB_OUTPUT

      - name: Export IMAGE_URI
        id: export
        run: |
          echo "image_uri=$IMAGE_URI" >> $GITHUB_OUTPUT
          echo "âœ… Exported IMAGE_URI: $IMAGE_URI"

  terraform-deploy:
    name: Terraform Apply â†’ Deploy to EKS
    runs-on: ubuntu-latest
    needs: build-and-push
    env:
      TF_WORKING_DIR: "."
      IMAGE_URI: ${{ needs.build-and-push.outputs.image_uri }}
      AWS_REGION: ${{ env.AWS_REGION }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.13.4

      - name: Terraform Init
        run: terraform -chdir=${{ env.TF_WORKING_DIR }} init

      - name: Terraform Plan
        run: |
          echo "ðŸ” Using IMAGE_URI=${{ env.IMAGE_URI }}"
          terraform -chdir=${{ env.TF_WORKING_DIR }} plan -var="image_uri=${{ env.IMAGE_URI }}" -out=tfplan

      - name: Terraform Apply
        run: terraform -chdir=${{ env.TF_WORKING_DIR }} apply -auto-approve tfplan

      - name: Output Terraform Results
        if: always()
        run: |
          echo "=== Terraform Outputs ==="
          terraform output -json > outputs.json
          cat outputs.json
          echo ""
          echo "Grafana: http://$(terraform output -raw grafana_load_balancer_address)"
          echo "Argo CD: http://$(terraform output -raw argocd_server_address)"

  argocd-sync:
    name: Argo CD Sync
    runs-on: ubuntu-latest
    needs: terraform-deploy
    env:
      ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}      # e.g., argocd.example.com
      ARGOCD_USERNAME: ${{ secrets.ARGOCD_USERNAME }}  # ArgoCD admin/user
      ARGOCD_PASSWORD: ${{ secrets.ARGOCD_PASSWORD }}  # Password or token
      APP_NAME: "uchenewwebsit-app"                    # ArgoCD app name

    steps:
      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          sudo mv argocd /usr/local/bin/

      - name: Login to Argo CD
        run: |
          argocd login $ARGOCD_SERVER \
            --username $ARGOCD_USERNAME \
            --password $ARGOCD_PASSWORD \
            --insecure

      - name: Sync Application
        run: |
          echo "ðŸ”„ Syncing Argo CD application: $APP_NAME"
          argocd app sync $APP_NAME
          argocd app wait $APP_NAME --health --timeout 300
